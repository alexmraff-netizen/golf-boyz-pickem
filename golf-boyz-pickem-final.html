<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Boyz Pick 'Em</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f4c3a 0%, #1a7a5e 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        h1 {
            color: #0f4c3a;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        /* Toolbar Styles */
        .toolbar {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }
        
        .toolbar-btn {
            background: #f5f5f5;
            color: #333;
            border: 2px solid transparent;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .toolbar-btn:hover {
            background: #e0e0e0;
        }
        
        .toolbar-btn.active {
            background: #1a7a5e;
            color: white;
            border-color: #0f4c3a;
        }
        
        .content-section {
            display: none;
        }
        
        @media (max-width: 768px) {
            .toolbar {
                padding: 10px;
                gap: 8px;
            }
            
            .toolbar-btn {
                font-size: 0.85em;
                padding: 10px 16px;
            }
        }
        
        @media (max-width: 480px) {
            .toolbar {
                flex-direction: column;
            }
            
            .toolbar-btn {
                width: 100%;
            }
        }
        
        
        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #0f4c3a;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #1a7a5e;
            padding-bottom: 10px;
        }
        
        .leaderboard {
            grid-column: 1 / -1;
        }
        
        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leaderboard-table th {
            background: #0f4c3a;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .leaderboard-table td {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .leaderboard-table tr:hover {
            background: #f5f5f5;
        }
        
        .rank {
            font-weight: bold;
            font-size: 1.2em;
            color: #0f4c3a;
        }
        
        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }
        
        .money {
            color: #2e7d32;
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #1a7a5e;
        }
        
        button {
            background: #1a7a5e;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }
        
        button:hover {
            background: #0f4c3a;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .pick-order {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .pick-order h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .pick-order-list {
            list-style: none;
        }
        
        .pick-order-list li {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .current-pick {
            background: #28a745 !important;
            color: white;
        }
        
        .picks-history {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .pick-item {
            background: #f8f9fa;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border-left: 4px solid #1a7a5e;
        }
        
        .pick-item strong {
            color: #0f4c3a;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #bee5eb;
        }
        
        .setup-section {
            margin-bottom: 20px;
        }
        
        .player-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .player-input input {
            flex: 1;
        }
        
        .player-list {
            list-style: none;
            margin-top: 15px;
        }
        
        .player-list li {
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .remove-btn:hover {
            background: #c82333;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .tournament-select {
            margin-bottom: 20px;
        }
        
        .used-golfers {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .used-golfers h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .used-golfers ul {
            list-style: none;
            columns: 2;
        }
        
        .used-golfers li {
            padding: 3px 0;
            color: #666;
        }
        
        .projected-earnings {
            color: #ff9800;
            font-weight: 600;
        }
        
        .golfer-position {
            font-size: 0.9em;
            color: #666;
        }
        
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .current-total {
            color: #666;
            font-size: 0.95em;
        }
        
        .projected-total {
            color: #1a7a5e;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
        }
        
        .btn-group button {
            flex: 1;
        }
        
        .past-results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .past-results-table th {
            background: #0f4c3a;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .past-results-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .past-results-table tr:hover {
            background: #f5f5f5;
        }
        
        .tournament-winner {
            background: #fff8e1 !important;
            border-left: 4px solid #ffc107;
        }
        
        .week-earnings {
            font-weight: 600;
            color: #2e7d32;
        }
        
        .tournament-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #1a7a5e;
        }
        
        .tournament-summary h4 {
            color: #0f4c3a;
            margin-bottom: 8px;
        }
        
        .summary-stat {
            display: inline-block;
            margin-right: 20px;
            color: #666;
        }
        
        .summary-stat strong {
            color: #333;
        }
        
        .player-picks-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .player-picks-table th {
            background: #0f4c3a;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        
        .player-picks-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .player-picks-table tr:hover {
            background: #f5f5f5;
        }
        
        .player-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        
        .player-summary h4 {
            color: #0f4c3a;
            margin-bottom: 8px;
            font-size: 1.2em;
        }
        
        .golfer-used {
            color: #666;
            font-style: italic;
        }
        
        .no-earnings {
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèåÔ∏è Golf Boyz Pick 'Em</h1>
            <p class="subtitle">Season-long fantasy golf competition</p>
        </header>
        
        <div id="loginSection">
            <div class="card" style="max-width: 500px; margin: 0 auto;">
                <h2>Player Login</h2>
                <div class="info">Select your name to continue</div>
                <div class="form-group">
                    <label>Who are you?</label>
                    <select id="loginPlayerSelect" style="font-size: 1.2em; padding: 15px;">
                        <option value="">Select your name</option>
                        <option value="Alex Raff">Alex Raff</option>
                        <option value="Ben Orgel">Ben Orgel</option>
                        <option value="Evan Levin">Evan Levin</option>
                        <option value="Eric Rosenfeld">Eric Rosenfeld</option>
                    </select>
                </div>
                <button onclick="loginPlayer()" id="loginBtn" style="font-size: 1.1em; padding: 15px;">Continue</button>
            </div>
        </div>
        
        <div id="gameSection" style="display: none;">
            <!-- Season Leaderboard - Full Width at Top -->
            <div class="card leaderboard" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">üí∞ Season Leaderboard</h2>
                    <button onclick="manualRefreshLiveData()" id="refreshLiveDataBtn" style="display: none; padding: 8px 16px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        üîÑ Refresh Live Data
                    </button>
                </div>
                <div id="leaderboardTournamentInfo" style="margin-bottom: 15px; color: #666; font-size: 0.95em;"></div>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Total Earnings</th>
                            <th>This Week's Pick</th>
                            <th>Projected Earnings</th>
                            <th>Projected Total</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                    </tbody>
                </table>
            </div>
            
            <!-- Function Toolbar -->
            <div class="toolbar" style="margin-bottom: 30px;">
                <button onclick="showSection('makePick')" class="toolbar-btn" id="btn-makePick">üìã Make Pick</button>
                <button onclick="showSection('results')" class="toolbar-btn" id="btn-results">üóìÔ∏è Tournament Results</button>
                <button onclick="showSection('playerPicks')" class="toolbar-btn" id="btn-playerPicks">üë• All Player Picks</button>
                <button onclick="showSection('pastResults')" class="toolbar-btn" id="btn-pastResults">üìÖ Past Weeks</button>
                <button onclick="showSection('pickHistory')" class="toolbar-btn" id="btn-pickHistory">üìä Pick History</button>
            </div>
            
            <!-- Content Sections (Hidden by Default) -->
            <div id="section-makePick" class="content-section" style="display: none;">
                <div class="card">
                    <h2>üìã Make Your Pick</h2>
                    <div class="pick-order" id="pickOrder"></div>
                    
                    <div class="info" style="background: #e3f2fd; border-color: #2196f3; margin-bottom: 15px;">
                        <strong>Logged in as: <span id="currentPlayerName"></span></strong>
                        <button onclick="logoutPlayer()" style="float: right; padding: 5px 15px; font-size: 0.9em; background: #dc3545;">Logout</button>
                        <div style="clear: both;"></div>
                    </div>
                    
                    <div class="form-group tournament-select">
                        <label>Current Tournament</label>
                        <select id="tournamentSelect" onchange="loadTournamentField()">
                            <option value="">Loading tournaments...</option>
                        </select>
                    </div>
                    
                    <div id="pickForm">
                        <div class="form-group">
                            <label>Golfer to Pick</label>
                            <select id="golferSelect" style="font-size: 1em;">
                                <option value="">Loading golfers...</option>
                            </select>
                        </div>
                        
                        <div class="used-golfers" id="usedGolfersSection" style="display: none;">
                            <h4>Your Already Used Golfers:</h4>
                            <ul id="usedGolfersList"></ul>
                        </div>
                        
                        <button onclick="submitPick()">Submit Pick</button>
                        
                        <div id="pickMessage"></div>
                    </div>
                </div>
            </div>
            
            <div id="section-results" class="content-section" style="display: none;">
                <div class="card">
                    <h2>üóìÔ∏è Tournament Results</h2>
                    <div class="form-group">
                        <label>Tournament</label>
                        <select id="resultTournamentSelect">
                            <option value="">Select tournament</option>
                        </select>
                    </div>
                    <div class="btn-group">
                        <button onclick="fetchTournamentResults(true)" style="background: #ff9800; color: white;">üìà Live Leaderboard</button>
                        <button onclick="fetchTournamentResults(false)">‚úì Final Results</button>
                    </div>
                    <div id="resultsMessage"></div>
                </div>
            </div>
            
            <div id="section-pickHistory" class="content-section" style="display: none;">
                <div class="card">
                    <h2>üìä Pick History</h2>
                    <div class="picks-history" id="pickHistory"></div>
            </div>
            
            <div id="section-playerPicks" class="content-section" style="display: none;">
                <div class="card">
                    <h2>üë• All Player Picks</h2>
                    <div class="form-group">
                        <label>Select Player</label>
                        <select id="allPicksPlayerSelect" onchange="displayAllPlayerPicks()">
                            <option value="">Choose a player...</option>
                        </select>
                    </div>
                    <div id="allPlayerPicksDisplay"></div>
                </div>
            </div>
            
            <div id="section-pastResults" class="content-section" style="display: none;">
                <div class="card">
                    <h2>üìÖ Past Week Results</h2>
                    <div class="form-group">
                        <label>Select Tournament</label>
                        <select id="pastResultsSelect" onchange="displayPastResults()">
                            <option value="">Choose a tournament...</option>
                        </select>
                    </div>
                    <div id="pastResultsDisplay"></div>
                </div>
            </div>
                
                <div class="card" id="projectedLeaderboardCard" style="display: none;">
                    <h2>üìà Projected Leaderboard (Live)</h2>
                    <div class="info" id="projectedTimestamp"></div>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Proj. Rank</th>
                                <th>Player</th>
                                <th>Current Total</th>
                                <th>This Week's Golfer</th>
                                <th>Golfer Position</th>
                                <th>Week Earnings (Proj.)</th>
                                <th>Projected Total</th>
                            </tr>
                        </thead>
                        <tbody id="projectedLeaderboardBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let gameState = {
            players: [
                { name: 'Alex Raff', totalEarnings: 0, picks: [] },
                { name: 'Ben Orgel', totalEarnings: 0, picks: [] },
                { name: 'Evan Levin', totalEarnings: 0, picks: [] },
                { name: 'Eric Rosenfeld', totalEarnings: 0, picks: [] }
            ],
            picks: [],
            tournaments: [
                {name: 'Sony Open in Hawaii', date: '2026-01-15', id: 'sony2025'},
                {name: 'The American Express', date: '2026-01-22', id: 'amex2025'},
                {name: 'Farmers Insurance Open', date: '2026-01-29', id: 'farmers2025'},
                {name: 'WM Phoenix Open', date: '2026-02-05', id: 'phoenix2025'},
                {name: 'AT&T Pebble Beach Pro-Am', date: '2026-02-12', id: 'pebble2025'},
                {name: 'The Genesis Invitational', date: '2026-02-19', id: 'genesis2025'},
                {name: 'The Players Championship', date: '2026-03-12', id: 'players2025'},
                {name: 'Masters Tournament', date: '2026-04-09', id: 'masters2025'},
                {name: 'PGA Championship', date: '2026-05-14', id: 'pga2025'},
                {name: 'U.S. Open', date: '2026-06-18', id: 'usopen2025'},
                {name: 'The Open Championship', date: '2026-07-16', id: 'open2025'}
            ],
            currentTournament: null
        };
        
        // Pre-loaded historical picks - 2025-2026 PGA TOUR SEASON
        const historicalPicks = [
            {player: 'Alex Raff', golfer: 'Si Woo Kim', tournament: 'sony2025', earnings: 220675, date: '2026-01-10T12:00:00.000Z'},
            {player: 'Alex Raff', golfer: 'Sam Burns', tournament: 'amex2025', earnings: 57918, date: '2026-01-17T12:00:00.000Z'},
            {player: 'Alex Raff', golfer: 'Max Homa', tournament: 'farmers2025', earnings: 0, date: '2026-01-24T12:00:00.000Z'},
            {player: 'Alex Raff', golfer: 'Hideki Matsuyama', tournament: 'phoenix2025', earnings: 1046400, date: '2026-01-31T12:00:00.000Z'},
            {player: 'Alex Raff', golfer: 'Rory McIlroy', tournament: 'pebble2025', earnings: 0, date: '2026-02-07T12:00:00.000Z'},
            {player: 'Eric Rosenfeld', golfer: 'Robert MacIntyre', tournament: 'sony2025', earnings: 409500, date: '2026-01-10T13:00:00.000Z'},
            {player: 'Eric Rosenfeld', golfer: 'Denny McCarthy', tournament: 'amex2025', earnings: 0, date: '2026-01-17T13:00:00.000Z'},
            {player: 'Eric Rosenfeld', golfer: 'Jason Day', tournament: 'farmers2025', earnings: 42720, date: '2026-01-24T13:00:00.000Z'},
            {player: 'Eric Rosenfeld', golfer: 'Sahith Theegala', tournament: 'phoenix2025', earnings: 122720, date: '2026-01-31T13:00:00.000Z'},
            {player: 'Eric Rosenfeld', golfer: 'Russell Henley', tournament: 'pebble2025', earnings: 0, date: '2026-02-07T13:00:00.000Z'},
            {player: 'Evan Levin', golfer: 'JJ Spaun', tournament: 'sony2025', earnings: 31522, date: '2026-01-10T14:00:00.000Z'},
            {player: 'Evan Levin', golfer: 'Matt Fitzpatrick', tournament: 'amex2025', earnings: 0, date: '2026-01-17T14:00:00.000Z'},
            {player: 'Evan Levin', golfer: 'Cameron Young', tournament: 'farmers2025', earnings: 92640, date: '2026-01-24T14:00:00.000Z'},
            {player: 'Evan Levin', golfer: 'Brooks Koepka', tournament: 'phoenix2025', earnings: 0, date: '2026-01-31T14:00:00.000Z'},
            {player: 'Evan Levin', golfer: 'Viktor Hovland', tournament: 'pebble2025', earnings: 0, date: '2026-02-07T14:00:00.000Z'},
            {player: 'Ben Orgel', golfer: 'Harry Hall', tournament: 'sony2025', earnings: 287105, date: '2026-01-10T15:00:00.000Z'},
            {player: 'Ben Orgel', golfer: 'Ben Griffin', tournament: 'amex2025', earnings: 85100, date: '2026-01-17T15:00:00.000Z'},
            {player: 'Ben Orgel', golfer: 'Sam Stevens', tournament: 'farmers2025', earnings: 57531, date: '2026-01-24T15:00:00.000Z'},
            {player: 'Ben Orgel', golfer: 'Jordan Spieth', tournament: 'phoenix2025', earnings: 0, date: '2026-01-31T15:00:00.000Z'},
            {player: 'Ben Orgel', golfer: 'Si Woo Kim', tournament: 'pebble2025', earnings: 0, date: '2026-02-07T15:00:00.000Z'}
        ];
        
        let currentPlayer = null;
        // Load saved state
        async function loadGameState() {
            try {
                const stored = await window.storage.get('pga-game-state', true); // shared storage
                if (stored && stored.value) {
                    gameState = JSON.parse(stored.value);
                } else {
                    // First time loading - initialize with historical picks
                    gameState.picks = [...historicalPicks];
                    
                    // Assign picks to players
                    historicalPicks.forEach(pick => {
                        const player = gameState.players.find(p => p.name === pick.player);
                        if (player) {
                            player.picks.push(pick);
                        }
                    });
                    
                    // Save the initial state
                    await saveGameState();
                }
            } catch (error) {
                console.log('No saved game state found, initializing with historical picks');
                // Initialize with historical picks
                gameState.picks = [...historicalPicks];
                
                // Assign picks to players
                historicalPicks.forEach(pick => {
                    const player = gameState.players.find(p => p.name === pick.player);
                    if (player) {
                        player.picks.push(pick);
                    }
                });
                
                // Save the initial state
                await saveGameState();
            }
            
            // Check if player was previously logged in
            try {
                const playerStored = await window.storage.get('pga-current-player', false); // personal storage
                if (playerStored && playerStored.value) {
                    currentPlayer = playerStored.value;
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('gameSection').style.display = 'block';
                    updateUI();
                    updateTournamentSelects();
                }
            } catch (error) {
                console.log('No logged in player found');
            }
        }
        
        // Save game state
        async function saveGameState() {
            try {
                await window.storage.set('pga-game-state', JSON.stringify(gameState), true); // shared storage
                updateTournamentSelects(); // Refresh tournament dropdowns including past results
            } catch (error) {
                console.error('Error saving game state:', error);
            }
        }
        
        // Login player
        async function loginPlayer() {
            const playerName = document.getElementById('loginPlayerSelect').value;
            
            if (!playerName) {
                alert('Please select your name');
                return;
            }
            
            currentPlayer = playerName;
            
            // Save current player to personal storage
            try {
                await window.storage.set('pga-current-player', playerName, false);
            } catch (error) {
                console.error('Error saving player login:', error);
            }
            
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
            updateUI();
            updateTournamentSelects();
        }
        
        // Logout function
        function logoutPlayer() {
            if (confirm('Are you sure you want to log out?')) {
                currentPlayer = null;
                window.storage.delete('pga-current-player', false).catch(e => console.error(e));
                document.getElementById('gameSection').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';
            }
        }
        
        // Load PGA Tour tournaments
        async function loadTournaments() {
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: 'List the PGA Tour tournaments for the 2025 season in chronological order. Return ONLY a JSON array with this exact format: [{"name": "The Sentry", "date": "2025-01-02", "id": "sentry2025"}, ...]. Include major tournaments and regular tour events. Use lowercase id with no spaces.'
                        }]
                    })
                });
                
                const data = await response.json();
                const content = data.content[0].text;
                const jsonMatch = content.match(/\[[\s\S]*\]/);
                
                if (jsonMatch) {
                    gameState.tournaments = JSON.parse(jsonMatch[0]);
                    updateTournamentSelects();
                }
            } catch (error) {
                console.error('Error loading tournaments:', error);
                // Fallback tournaments
                gameState.tournaments = [
                    {name: "The Sentry", date: "2025-01-02", id: "sentry2025"},
                    {name: "Sony Open", date: "2025-01-09", id: "sony2025"},
                    {name: "The American Express", date: "2025-01-16", id: "amex2025"}
                ];
                updateTournamentSelects();
            }
        }
        
        function updateTournamentSelects() {
            const select1 = document.getElementById('tournamentSelect');
            const select2 = document.getElementById('resultTournamentSelect');
            const select3 = document.getElementById('pastResultsSelect');
            
            select1.innerHTML = '<option value="">Select tournament</option>';
            select2.innerHTML = '<option value="">Select tournament</option>';
            select3.innerHTML = '<option value="">Choose a tournament...</option>';
            
            gameState.tournaments.forEach(t => {
                const option1 = document.createElement('option');
                option1.value = t.id;
                option1.textContent = `${t.name} (${t.date})`;
                select1.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = t.id;
                option2.textContent = `${t.name} (${t.date})`;
                select2.appendChild(option2);
                
                // Only add to past results if tournament has picks
                const tournamentPicks = gameState.picks.filter(p => p.tournament === t.id);
                if (tournamentPicks.length > 0) {
                    const option3 = document.createElement('option');
                    option3.value = t.id;
                    const hasEarnings = tournamentPicks.some(p => p.earnings > 0);
                    option3.textContent = `${t.name} (${t.date})${hasEarnings ? ' ‚úì' : ''}`;
                    select3.appendChild(option3);
                }
            });
        }
        
        // Load golfer field for tournament
        async function loadTournamentField() {
            const tournamentId = document.getElementById('tournamentSelect').value;
            const golferSelect = document.getElementById('golferSelect');
            
            if (!tournamentId) {
                golferSelect.innerHTML = '<option value="">Select a tournament first</option>';
                return;
            }
            
            gameState.currentTournament = tournamentId;
            golferSelect.innerHTML = '<option value="">Loading field...</option>';
            
            const tournament = gameState.tournaments.find(t => t.id === tournamentId);
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2000,
                        tools: [{type: "web_search_20250305", name: "web_search"}],
                        messages: [{
                            role: 'user',
                            content: `Search for the official field list of golfers playing in the ${tournament.name} PGA Tour tournament${tournament.date ? ' on ' + tournament.date : ''}. Return ONLY a JSON array of golfer names like: ["Scottie Scheffler", "Rory McIlroy", "Jon Rahm", ...]. Include as many confirmed players as possible.`
                        }]
                    })
                });
                
                const data = await response.json();
                const content = data.content.find(c => c.type === 'text')?.text || '';
                const jsonMatch = content.match(/\[[\s\S]*?\]/);
                
                let golfers = [];
                if (jsonMatch) {
                    golfers = JSON.parse(jsonMatch[0]);
                } else {
                    // Fallback to common tour players if search fails
                    golfers = [
                        'Scottie Scheffler', 'Rory McIlroy', 'Viktor Hovland', 'Jon Rahm',
                        'Brooks Koepka', 'Xander Schauffele', 'Patrick Cantlay', 'Wyndham Clark',
                        'Collin Morikawa', 'Jordan Spieth', 'Justin Thomas', 'Max Homa',
                        'Tommy Fleetwood', 'Rickie Fowler', 'Tony Finau', 'Sam Burns',
                        'Cameron Young', 'Russell Henley', 'Sahith Theegala', 'Keegan Bradley',
                        'Hideki Matsuyama', 'Byeong Hun An', 'Matt Fitzpatrick', 'Tyrrell Hatton',
                        'Jason Day', 'Min Woo Lee', 'Shane Lowry', 'Robert MacIntyre',
                        'Akshay Bhatia', 'Ludvig Aberg', 'Will Zalatoris', 'Adam Scott'
                    ];
                }
                
                populateGolferDropdown(golfers);
                
            } catch (error) {
                console.error('Error loading field:', error);
                // Use fallback list on error
                const fallbackGolfers = [
                    'Scottie Scheffler', 'Rory McIlroy', 'Viktor Hovland', 'Jon Rahm',
                    'Brooks Koepka', 'Xander Schauffele', 'Patrick Cantlay', 'Wyndham Clark',
                    'Collin Morikawa', 'Jordan Spieth', 'Justin Thomas', 'Max Homa',
                    'Tommy Fleetwood', 'Rickie Fowler', 'Tony Finau', 'Sam Burns'
                ];
                populateGolferDropdown(fallbackGolfers);
            }
            
            updatePickOrder();
            updateUsedGolfers();
        }
        
        // Populate golfer dropdown with smart filtering
        function populateGolferDropdown(allGolfers) {
            const golferSelect = document.getElementById('golferSelect');
            const player = gameState.players.find(p => p.name === currentPlayer);
            const tournamentId = gameState.currentTournament;
            
            // Get golfers already used by current player
            const usedByPlayer = new Set(player.picks.map(p => p.golfer.toLowerCase()));
            
            // Get golfers already picked by others for THIS tournament
            const pickedThisTournament = new Set(
                gameState.picks
                    .filter(p => p.tournament === tournamentId && p.player !== currentPlayer)
                    .map(p => p.golfer.toLowerCase())
            );
            
            golferSelect.innerHTML = '<option value="">Select a golfer...</option>';
            
            // Separate available and unavailable golfers
            const available = [];
            const usedByYou = [];
            const pickedByOthers = [];
            
            allGolfers.forEach(golfer => {
                const lowerName = golfer.toLowerCase();
                if (usedByPlayer.has(lowerName)) {
                    usedByYou.push(golfer);
                } else if (pickedThisTournament.has(lowerName)) {
                    pickedByOthers.push(golfer);
                } else {
                    available.push(golfer);
                }
            });
            
            // Add available golfers
            if (available.length > 0) {
                available.sort().forEach(golfer => {
                    const option = document.createElement('option');
                    option.value = golfer;
                    option.textContent = golfer;
                    golferSelect.appendChild(option);
                });
            }
            
            // Add separator and unavailable golfers (disabled)
            if (usedByYou.length > 0 || pickedByOthers.length > 0) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Unavailable ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
                golferSelect.appendChild(separator);
            }
            
            // Add golfers you've already used (disabled)
            if (usedByYou.length > 0) {
                usedByYou.sort().forEach(golfer => {
                    const option = document.createElement('option');
                    option.value = golfer;
                    option.textContent = `${golfer} (Already used by you)`;
                    option.disabled = true;
                    option.style.color = '#999';
                    option.style.fontStyle = 'italic';
                    golferSelect.appendChild(option);
                });
            }
            
            // Add golfers picked by others this week (disabled)
            if (pickedByOthers.length > 0) {
                pickedByOthers.sort().forEach(golfer => {
                    const option = document.createElement('option');
                    option.value = golfer;
                    option.textContent = `${golfer} (Picked by another player)`;
                    option.disabled = true;
                    option.style.color = '#999';
                    option.style.fontStyle = 'italic';
                    golferSelect.appendChild(option);
                });
            }
        }
        
        // Update pick order based on current standings
        function updatePickOrder() {
            const sorted = [...gameState.players].sort((a, b) => a.totalEarnings - b.totalEarnings);
            
            const pickOrderDiv = document.getElementById('pickOrder');
            pickOrderDiv.innerHTML = '<h3>This Week\'s Pick Order (Lowest $ picks first):</h3><ol class="pick-order-list">';
            
            sorted.forEach((player, index) => {
                const li = document.createElement('li');
                const isCurrentPlayer = player.name === currentPlayer;
                const championBadge = player.isChampion ? ' üèÜ' : '';
                li.textContent = `${player.name}${championBadge} ($${player.totalEarnings.toLocaleString()})`;
                
                if (isCurrentPlayer) {
                    li.style.background = '#2196f3';
                    li.style.color = 'white';
                    li.style.fontWeight = 'bold';
                    li.innerHTML += ' üë§ (You)';
                }
                
                if (index === 0 && !isCurrentPlayer) {
                    li.classList.add('current-pick');
                }
                
                pickOrderDiv.querySelector('ol').appendChild(li);
            });
        }
        
        // Submit pick
        async function submitPick() {
            const playerName = currentPlayer;
            const golferName = document.getElementById('golferSelect').value.trim();
            const tournamentId = gameState.currentTournament;
            
            const messageDiv = document.getElementById('pickMessage');
            messageDiv.innerHTML = '';
            
            if (!playerName || !golferName || !tournamentId) {
                messageDiv.innerHTML = '<div class="error">Please select a tournament and a golfer</div>';
                return;
            }
            
            const player = gameState.players.find(p => p.name === playerName);
            
            // CRITICAL CHECK: Golfer can only be picked once per player per season
            const previousPick = player.picks.find(p => p.golfer.toLowerCase() === golferName.toLowerCase());
            if (previousPick) {
                const tournament = gameState.tournaments.find(t => t.id === previousPick.tournament);
                messageDiv.innerHTML = `<div class="error"><strong>‚ùå You cannot pick ${golferName} again!</strong><br>You already picked this golfer in ${tournament?.name || 'a previous tournament'}.<br>Each golfer can only be used once per season.</div>`;
                return;
            }
            
            // Check if golfer already picked for this tournament by another player
            if (gameState.picks.find(p => p.tournament === tournamentId && p.golfer.toLowerCase() === golferName.toLowerCase())) {
                messageDiv.innerHTML = '<div class="error">This golfer has already been picked for this tournament by another player!</div>';
                return;
            }
            
            // Check if this player already made a pick for this tournament
            if (gameState.picks.find(p => p.tournament === tournamentId && p.player === playerName)) {
                messageDiv.innerHTML = '<div class="error">You\'ve already made a pick for this tournament!</div>';
                return;
            }
            
            const pick = {
                player: playerName,
                golfer: golferName,
                tournament: tournamentId,
                earnings: 0,
                date: new Date().toISOString()
            };
            
            gameState.picks.push(pick);
            player.picks.push(pick);
            
            await saveGameState();
            updateUI();
            
            messageDiv.innerHTML = '<div class="success">‚úì Pick submitted successfully!</div>';
            document.getElementById('golferSelect').value = '';
            
            // Refresh the dropdown to show this golfer as now unavailable
            loadTournamentField();
        }
        
        // Fetch tournament results
        async function fetchTournamentResults(isLive = false) {
            const tournamentId = document.getElementById('resultTournamentSelect').value;
            const messageDiv = document.getElementById('resultsMessage');
            
            if (!tournamentId) {
                messageDiv.innerHTML = '<div class="error">Please select a tournament</div>';
                return;
            }
            
            const tournament = gameState.tournaments.find(t => t.id === tournamentId);
            const queryType = isLive ? 'current live leaderboard with positions and projected prize money' : 'final prize money/earnings';
            
            messageDiv.innerHTML = `<div class="loading">${isLive ? 'Fetching live leaderboard...' : 'Fetching final results...'}</div>`;
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        tools: [{type: "web_search_20250305", name: "web_search"}],
                        messages: [{
                            role: 'user',
                            content: `Search for the ${queryType} for the ${tournament.name} PGA Tour tournament. Return results as JSON: [{"name": "Player Name", "earnings": 1500000, "position": "T5", "status": "live"}, ...]. For live tournaments, include current position and projected earnings. Only include players who made/will make the cut.`
                        }]
                    })
                });
                
                const data = await response.json();
                console.log('Tournament results:', data);
                
                // Parse and update earnings
                const content = data.content.find(c => c.type === 'text')?.text || '';
                const jsonMatch = content.match(/\[[\s\S]*\]/);
                
                if (jsonMatch) {
                    const results = JSON.parse(jsonMatch[0]);
                    
                    if (isLive) {
                        displayProjectedLeaderboard(tournamentId, results);
                        messageDiv.innerHTML = '<div class="success">Live leaderboard updated! Scroll down to see projected standings.</div>';
                    } else {
                        updateEarnings(tournamentId, results);
                        messageDiv.innerHTML = '<div class="success">Final results updated successfully!</div>';
                    }
                } else {
                    messageDiv.innerHTML = '<div class="info">Results fetched. Please verify manually.</div>';
                }
            } catch (error) {
                console.error('Error fetching results:', error);
                messageDiv.innerHTML = '<div class="error">Error fetching results. Please try again.</div>';
            }
        }
        
        // Display past tournament results
        function displayPastResults() {
            const tournamentId = document.getElementById('pastResultsSelect').value;
            const displayDiv = document.getElementById('pastResultsDisplay');
            
            if (!tournamentId) {
                displayDiv.innerHTML = '';
                return;
            }
            
            const tournament = gameState.tournaments.find(t => t.id === tournamentId);
            const tournamentPicks = gameState.picks.filter(p => p.tournament === tournamentId);
            
            if (tournamentPicks.length === 0) {
                displayDiv.innerHTML = '<div class="info">No picks found for this tournament</div>';
                return;
            }
            
            // Sort by earnings (highest first)
            const sortedPicks = [...tournamentPicks].sort((a, b) => b.earnings - a.earnings);
            
            // Calculate stats
            const totalEarnings = sortedPicks.reduce((sum, p) => sum + p.earnings, 0);
            const avgEarnings = totalEarnings / sortedPicks.length;
            const winner = sortedPicks[0];
            
            // Build display
            let html = `
                <div class="tournament-summary">
                    <h4>${tournament.name}</h4>
                    <div class="summary-stat">
                        <strong>Week Winner:</strong> ${winner.player}
                    </div>
                    <div class="summary-stat">
                        <strong>Top Earnings:</strong> $${winner.earnings.toLocaleString()}
                    </div>
                    <div class="summary-stat">
                        <strong>Total Week Earnings:</strong> $${totalEarnings.toLocaleString()}
                    </div>
                    <div class="summary-stat">
                        <strong>Average:</strong> $${Math.round(avgEarnings).toLocaleString()}
                    </div>
                </div>
                
                <table class="past-results-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Player</th>
                            <th>Golfer Picked</th>
                            <th>Earnings</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedPicks.forEach((pick, index) => {
                const isWinner = index === 0 && pick.earnings > 0;
                const rowClass = isWinner ? 'tournament-winner' : '';
                
                html += `
                    <tr class="${rowClass}">
                        <td><strong>${index + 1}</strong>${isWinner ? ' üëë' : ''}</td>
                        <td><strong>${pick.player}</strong></td>
                        <td>${pick.golfer}</td>
                        <td class="week-earnings">$${pick.earnings.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            displayDiv.innerHTML = html;
        }
        
        function updateEarnings(tournamentId, results) {
            gameState.picks.forEach(pick => {
                if (pick.tournament === tournamentId) {
                    const result = results.find(r => r.name.toLowerCase().includes(pick.golfer.toLowerCase()));
                    if (result) {
                        pick.earnings = result.earnings;
                        const player = gameState.players.find(p => p.name === pick.player);
                        player.totalEarnings = player.picks.reduce((sum, p) => sum + (p.earnings || 0), 0);
                    }
                }
            });
            
            saveGameState();
            updateUI();
        }
        
        // Display projected leaderboard for live tournament
        function displayProjectedLeaderboard(tournamentId, liveResults) {
            const card = document.getElementById('projectedLeaderboardCard');
            const tbody = document.getElementById('projectedLeaderboardBody');
            const timestamp = document.getElementById('projectedTimestamp');
            
            card.style.display = 'block';
            timestamp.innerHTML = `<span class="live-indicator"></span>Last updated: ${new Date().toLocaleString()}`;
            
            tbody.innerHTML = '';
            
            // Calculate projected totals for each player
            const projections = gameState.players.map(player => {
                const currentTotal = player.totalEarnings || 0;
                const thisTournamentPick = gameState.picks.find(p => 
                    p.player === player.name && p.tournament === tournamentId
                );
                
                let projectedEarnings = 0;
                let golferPosition = 'N/A';
                let golferName = 'No pick';
                
                if (thisTournamentPick) {
                    golferName = thisTournamentPick.golfer;
                    const liveResult = liveResults.find(r => 
                        r.name.toLowerCase().includes(golferName.toLowerCase())
                    );
                    
                    if (liveResult) {
                        projectedEarnings = liveResult.earnings || 0;
                        golferPosition = liveResult.position || 'MC';
                    }
                }
                
                return {
                    playerName: player.name,
                    currentTotal: currentTotal,
                    golferName: golferName,
                    golferPosition: golferPosition,
                    weekEarnings: projectedEarnings,
                    projectedTotal: currentTotal + projectedEarnings
                };
            });
            
            // Sort by projected total
            projections.sort((a, b) => b.projectedTotal - a.projectedTotal);
            
            projections.forEach((proj, index) => {
                const tr = document.createElement('tr');
                
                tr.innerHTML = `
                    <td><span class="rank rank-${index + 1}">#${index + 1}</span></td>
                    <td><strong>${proj.playerName}</strong></td>
                    <td class="current-total">$${proj.currentTotal.toLocaleString()}</td>
                    <td>${proj.golferName}</td>
                    <td class="golfer-position">${proj.golferPosition}</td>
                    <td class="projected-earnings">$${proj.weekEarnings.toLocaleString()}</td>
                    <td class="projected-total">$${proj.projectedTotal.toLocaleString()}</td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Scroll to projected leaderboard
            card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Update all UI elements
        function updateUI() {
            // Rebuild player.picks arrays from gameState.picks and recalculate totals
            gameState.players.forEach(player => {
                player.picks = gameState.picks.filter(p => p.player === player.name);
                player.totalEarnings = player.picks.reduce((sum, pick) => sum + (pick.earnings || 0), 0);
            });
            
            updateLeaderboard();
            updatePickHistory();
            updatePickOrder();
            updateUsedGolfers();
            updateAllPlayerPicksSelect();
            
            // Update current player display
            const playerNameSpan = document.getElementById('currentPlayerName');
            if (playerNameSpan) {
                playerNameSpan.textContent = currentPlayer;
            }
        }
        
        function updateLeaderboard() {
            const tbody = document.getElementById('leaderboardBody');
            const infoDiv = document.getElementById('leaderboardTournamentInfo');
            const refreshBtn = document.getElementById('refreshLiveDataBtn');
            
            if (!tbody || !infoDiv) {
                return;
            }
            
            tbody.innerHTML = '';
            
            // Find the current/next tournament or most recent with picks
            const today = new Date();
            let displayTournament = null;
            
            // First, look for upcoming tournaments with picks (preferred)
            for (const t of gameState.tournaments) {
                const tournamentDate = new Date(t.date);
                const daysDiff = Math.floor((tournamentDate - today) / (1000 * 60 * 60 * 24));
                
                // Upcoming tournament (0 to 14 days away) with picks
                if (daysDiff >= 0 && daysDiff <= 14) {
                    const hasPicks = gameState.picks.some(p => p.tournament === t.id);
                    if (hasPicks) {
                        displayTournament = t;
                        break;
                    }
                }
            }
            
            // If no upcoming tournament with picks, look for in-progress tournament
            if (!displayTournament) {
                for (const t of gameState.tournaments) {
                    const tournamentDate = new Date(t.date);
                    const daysDiff = Math.floor((tournamentDate - today) / (1000 * 60 * 60 * 24));
                    
                    // In-progress tournament (-4 to -1 days)
                    if (daysDiff >= -4 && daysDiff < 0) {
                        const hasPicks = gameState.picks.some(p => p.tournament === t.id);
                        if (hasPicks) {
                            displayTournament = t;
                            break;
                        }
                    }
                }
            }
            
            // If still nothing, find most recent tournament with picks
            if (!displayTournament) {
                const tournamentsWithPicks = gameState.tournaments
                    .filter(t => gameState.picks.some(p => p.tournament === t.id))
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (tournamentsWithPicks.length > 0) {
                    displayTournament = tournamentsWithPicks[0];
                }
            }
            
            // Store current tournament globally for manual refresh
            window.currentDisplayTournament = displayTournament;
            
            // Update info display and show/hide refresh button
            if (displayTournament) {
                const tournamentDate = new Date(displayTournament.date);
                const daysDiff = Math.floor((tournamentDate - today) / (1000 * 60 * 60 * 24));
                let status = '';
                let showRefreshBtn = false;
                
                if (daysDiff >= -4 && daysDiff < 0) {
                    status = ' üî¥ IN PROGRESS';
                    showRefreshBtn = true;
                } else if (daysDiff >= 0 && daysDiff <= 7) {
                    status = ' üìÖ THIS WEEK';
                }
                
                infoDiv.innerHTML = `<strong>Showing picks for:</strong> ${displayTournament.name} (${displayTournament.date})${status} <span id="liveDataStatus"></span>`;
                
                // Show/hide refresh button
                if (refreshBtn) {
                    refreshBtn.style.display = showRefreshBtn ? 'block' : 'none';
                }
            } else {
                infoDiv.innerHTML = '';
                if (refreshBtn) {
                    refreshBtn.style.display = 'none';
                }
            }
            
            // Render with current data
            renderLeaderboardRows(displayTournament);
        }
        
        // Manual refresh function callable by button
        function manualRefreshLiveData() {
            if (window.currentDisplayTournament) {
                fetchLiveDataAndUpdate(window.currentDisplayTournament);
            }
        }
        
        // Fetch live tournament data and update leaderboard
        async function fetchLiveDataAndUpdate(tournament) {
            const statusSpan = document.getElementById('liveDataStatus');
            if (statusSpan) {
                statusSpan.innerHTML = '<span style="color: #ff9800; margin-left: 10px;">‚è≥ Fetching live data...</span>';
            }
            
            console.log('=== FETCHING LIVE DATA ===');
            console.log('Tournament:', tournament.name, tournament.date);
            
            // Get the golfers we need data for
            const golfersToFind = gameState.picks
                .filter(p => p.tournament === tournament.id)
                .map(p => p.golfer);
            
            console.log('Looking for these golfers:', golfersToFind);
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        tools: [{type: "web_search_20250305", name: "web_search"}],
                        messages: [{
                            role: 'user',
                            content: `Search for the current live leaderboard for the ${tournament.name} PGA Tour tournament (date: ${tournament.date}). 

I need projected prize money for these specific golfers: ${golfersToFind.join(', ')}.

For each golfer:
1. Find their current position on the leaderboard
2. Look up the prize money payout for that position
3. If they missed the cut or withdrew, their earnings should be $0

Return ONLY a valid JSON object with golfer names as keys and projected earnings as numbers:
{"Golfer Name": 250000, "Another Golfer": 150000}

Make sure the golfer names match exactly: ${golfersToFind.join(', ')}`
                        }]
                    })
                });
                
                console.log('API Response status:', response.status);
                const data = await response.json();
                console.log('API Response data:', data);
                
                // Extract the response text
                const textContent = data.content
                    .filter(item => item.type === 'text')
                    .map(item => item.text)
                    .join('');
                
                console.log('Response text:', textContent);
                
                // Try to extract JSON from the response
                const jsonMatch = textContent.match(/\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/);
                
                if (jsonMatch) {
                    console.log('Found JSON:', jsonMatch[0]);
                    const liveData = JSON.parse(jsonMatch[0]);
                    console.log('Parsed live data:', liveData);
                    
                    // Update the picks with live earnings data
                    let updatedCount = 0;
                    gameState.picks.forEach(pick => {
                        if (pick.tournament === tournament.id) {
                            // Try exact match first
                            if (liveData[pick.golfer] !== undefined) {
                                pick.liveEarnings = liveData[pick.golfer];
                                updatedCount++;
                                console.log(`Updated ${pick.golfer}: $${liveData[pick.golfer]}`);
                            } else {
                                // Try case-insensitive match
                                const golferLower = pick.golfer.toLowerCase();
                                const matchedKey = Object.keys(liveData).find(key => 
                                    key.toLowerCase() === golferLower
                                );
                                if (matchedKey) {
                                    pick.liveEarnings = liveData[matchedKey];
                                    updatedCount++;
                                    console.log(`Updated ${pick.golfer} (matched ${matchedKey}): $${liveData[matchedKey]}`);
                                } else {
                                    console.log(`No match found for ${pick.golfer}`);
                                }
                            }
                        }
                    });
                    
                    console.log(`Updated ${updatedCount} golfers with live data`);
                    
                    // Re-render leaderboard with live data
                    renderLeaderboardRows(tournament);
                    
                    if (statusSpan) {
                        statusSpan.innerHTML = `<span style="color: #4caf50; margin-left: 10px;">‚úì Live data updated (${updatedCount} golfers)</span>`;
                    }
                } else {
                    console.log('No JSON found in response');
                    if (statusSpan) {
                        statusSpan.innerHTML = '<span style="color: #f44336; margin-left: 10px;">‚ö†Ô∏è Could not parse live data</span>';
                    }
                }
            } catch (error) {
                console.error('Error fetching live data:', error);
                if (statusSpan) {
                    statusSpan.innerHTML = '<span style="color: #f44336; margin-left: 10px;">‚ö†Ô∏è Live data unavailable</span>';
                }
            }
        }
        
        // Render leaderboard rows
        function renderLeaderboardRows(displayTournament) {
            const tbody = document.getElementById('leaderboardBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const sorted = [...gameState.players].sort((a, b) => b.totalEarnings - a.totalEarnings);
            
            sorted.forEach((player, index) => {
                const tr = document.createElement('tr');
                const isCurrentPlayer = player.name === currentPlayer;
                
                // Find this week's pick
                let weeklyPick = '-';
                let projectedEarnings = 0;
                let hasPick = false;
                
                if (displayTournament) {
                    const pick = gameState.picks.find(p => 
                        p.player === player.name && p.tournament === displayTournament.id
                    );
                    
                    if (pick) {
                        weeklyPick = pick.golfer;
                        hasPick = true;
                        
                        // Prefer live earnings, fall back to stored earnings
                        if (pick.liveEarnings !== undefined) {
                            projectedEarnings = pick.liveEarnings;
                        } else {
                            projectedEarnings = pick.earnings || 0;
                        }
                    }
                }
                
                const projectedTotal = player.totalEarnings + projectedEarnings;
                
                tr.innerHTML = `
                    <td><span class="rank rank-${index + 1}">#${index + 1}</span></td>
                    <td><strong>${player.name}</strong>${isCurrentPlayer ? ' üë§' : ''}</td>
                    <td class="money">$${player.totalEarnings.toLocaleString()}</td>
                    <td>${weeklyPick}</td>
                    <td class="money">${hasPick ? (projectedEarnings > 0 ? '$' + projectedEarnings.toLocaleString() : 'Pending') : '-'}</td>
                    <td class="money" style="font-weight: bold;">${hasPick && projectedEarnings > 0 ? '$' + projectedTotal.toLocaleString() : '$' + player.totalEarnings.toLocaleString()}</td>
                `;
                
                if (isCurrentPlayer) {
                    tr.style.background = '#f0f8ff';
                }
                
                tbody.appendChild(tr);
            });
        }
        
        // Show/hide content sections
        function showSection(sectionName) {
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Remove active class from all toolbar buttons
            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected section
            const section = document.getElementById('section-' + sectionName);
            if (section) {
                section.style.display = 'block';
            }
            
            // Highlight active button
            const button = document.getElementById('btn-' + sectionName);
            if (button) {
                button.classList.add('active');
            }
        }
        
        function updatePickHistory() {
            const historyDiv = document.getElementById('pickHistory');
            historyDiv.innerHTML = '';
            
            const sorted = [...gameState.picks].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (sorted.length === 0) {
                historyDiv.innerHTML = '<div class="info">No picks yet</div>';
                return;
            }
            
            sorted.forEach(pick => {
                const tournament = gameState.tournaments.find(t => t.id === pick.tournament);
                const div = document.createElement('div');
                div.className = 'pick-item';
                div.innerHTML = `
                    <strong>${pick.player}</strong> picked <strong>${pick.golfer}</strong><br>
                    <small>${tournament?.name || pick.tournament} - $${pick.earnings.toLocaleString()}</small>
                `;
                historyDiv.appendChild(div);
            });
        }
        
        function updateUsedGolfers() {
            const section = document.getElementById('usedGolfersSection');
            const list = document.getElementById('usedGolfersList');
            
            if (!currentPlayer) {
                section.style.display = 'none';
                return;
            }
            
            const player = gameState.players.find(p => p.name === currentPlayer);
            const usedGolfers = player.picks.map(p => p.golfer);
            
            if (usedGolfers.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            list.innerHTML = '';
            usedGolfers.forEach(golfer => {
                const li = document.createElement('li');
                li.textContent = golfer;
                list.appendChild(li);
            });
        }
        
        // Display all picks for a selected player
        function displayAllPlayerPicks() {
            const playerName = document.getElementById('allPicksPlayerSelect').value;
            const displayDiv = document.getElementById('allPlayerPicksDisplay');
            
            if (!playerName) {
                displayDiv.innerHTML = '';
                return;
            }
            
            const player = gameState.players.find(p => p.name === playerName);
            const playerPicks = player.picks;
            
            if (playerPicks.length === 0) {
                displayDiv.innerHTML = '<div class="info">No picks made yet this season</div>';
                return;
            }
            
            // Sort by date (most recent first)
            const sortedPicks = [...playerPicks].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Calculate stats
            const totalEarnings = player.totalEarnings;
            const avgEarnings = totalEarnings / playerPicks.length;
            const bestPick = [...playerPicks].sort((a, b) => b.earnings - a.earnings)[0];
            
            // Build display
            let html = `
                <div class="player-summary">
                    <h4>${playerName}'s Season</h4>
                    <div class="summary-stat">
                        <strong>Total Picks:</strong> ${playerPicks.length}
                    </div>
                    <div class="summary-stat">
                        <strong>Total Earnings:</strong> $${totalEarnings.toLocaleString()}
                    </div>
                    <div class="summary-stat">
                        <strong>Average per Pick:</strong> $${Math.round(avgEarnings).toLocaleString()}
                    </div>
                    <div class="summary-stat">
                        <strong>Best Pick:</strong> ${bestPick.golfer} ($${bestPick.earnings.toLocaleString()})
                    </div>
                </div>
                
                <table class="player-picks-table">
                    <thead>
                        <tr>
                            <th>Tournament</th>
                            <th>Golfer</th>
                            <th>Earnings</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedPicks.forEach(pick => {
                const tournament = gameState.tournaments.find(t => t.id === pick.tournament);
                const earningsClass = pick.earnings === 0 ? 'no-earnings' : 'week-earnings';
                
                html += `
                    <tr>
                        <td>${tournament?.name || pick.tournament}</td>
                        <td><strong>${pick.golfer}</strong></td>
                        <td class="${earningsClass}">$${pick.earnings.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            displayDiv.innerHTML = html;
        }
        
        // Update all player picks select dropdown
        function updateAllPlayerPicksSelect() {
            const select = document.getElementById('allPicksPlayerSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">Choose a player...</option>';
            
            gameState.players.forEach(player => {
                const option = document.createElement('option');
                option.value = player.name;
                option.textContent = `${player.name} (${player.picks.length} picks)`;
                select.appendChild(option);
            });
        }
        
        // Initialize
        loadGameState();
    </script>
</body>
</html>
